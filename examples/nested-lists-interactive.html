<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nested Lists Demo - Template Engine</title>
</head>
<body>

    <div id="app"></div>

    <template id="app-template">
        <h1>ğŸ¢ Company Organization Chart</h1>
        <p>User: <strong><get>name</get></strong> (<get>age</get> years old)</p>
        <p>Department: <get>param1</get></p>

        <h2>Team Structure</h2>
        <ul>
            <each of="persons" as="p">
                <li attr-item-id="p.id">
                    <strong><get>p.name</get></strong> - <get>p.role</get>
                    <button action-click="toggleEdit">âœï¸ Edit</button>
                    <button action-click="delete">ğŸ—‘ï¸ Delete</button>
                    
                    <if test="p.editing">
                        <input type="text" attr-value="p.name" action-input="updateName">
                    </if>

                    <ul>
                        <each of="p.childs" as="c">
                            <li attr-item-id="c.id" attr-parent-item-id="p.id">
                                <b><get>watermark</get></b>
                                <get>c.name</get> (<get>param1</get> team)
                                <button action-click="toggleChildEdit">âœï¸ Edit</button>
                                <button action-click="deleteChild">ğŸ—‘ï¸ Delete</button>
                                
                                <if test="c.editing">
                                    <input type="text" attr-value="c.name" action-input="updateChildName">
                                </if>
                            </li>
                        </each>
                    </ul>

                </li>
            </each>
        </ul>
    </template>

    <template-use id="app-template-use" template-id="app-template" mount-id="app" data-param1="Engineering"></template-use>

    <script type="module">
        import TemplateEngine from '../src/template-engine.js'

        const data = TemplateEngine.reactive({
            name: 'Sarah Wilson',
            age: 28,
            watermark: 'Confidential',
            persons: [{
                id: 1,
                name: 'Alex Chen',
                role: 'Tech Lead',
                editing: false,
                childs: [{
                    id: 1,
                    name: 'Maya Patel - Senior Developer',
                    editing: false,
                    childs: []
                }, {
                    id: 2,
                    name: 'Jordan Kim - Frontend Developer',
                    editing: false,
                    childs: []
                }]
            }, {
                id: 3,
                name: 'Chris Martinez',
                role: 'Product Manager',
                editing: false,
                childs: [{
                    id: 1,
                    name: 'Taylor Brown - UX Designer',
                    editing: false,
                    childs: []
                }]
            }],
            toggleEdit: (e, dataElement) => {
                //const person = data.persons.find(p => p.__item_index__ == dataElement.__item_index__)
                //console.log(person)
                const person = data.persons[dataElement.__item_index__]
                person.editing = !person.editing
            },
            updateName: (e, dataElement) => {
                const person = data.persons[dataElement.__item_index__]
                person.name = e.target.value
            },
            delete: (e, dataElement) => {
                const personIndex = data.persons[dataElement.__item_index__] ? dataElement.__item_index__ : -1
                if (personIndex !== -1) {
                    data.persons.splice(personIndex, 1)
                }
            },
            toggleChildEdit: (e, dataElement, contextStack) => {
                const person = data.persons[contextStack.get('p').data.__item_index__]
                const child = person.childs[dataElement.__item_index__]
                child.editing = !child.editing
            },
            updateChildName: (e, dataElement, contextStack) => {
                const person = data.persons[contextStack.get('p').data.__item_index__]
                const child = person.childs[dataElement.__item_index__]
                child.name = e.target.value
            },
            deleteChild: (e, dataElement, contextStack) => {
                const person = data.persons[contextStack.get('p').data.__item_index__]
                const childIndex = dataElement.__item_index__
                if (person && childIndex !== -1) {
                    person.childs.splice(childIndex, 1)
                }
            }
        }, document.getElementById('app-template-use'))

        // Demonstrate dynamic updates
        data.persons[0].name = 'Alex Chen (updated)'
        data.persons[0].childs.push({ id: 3, name: 'Sam Lee - Junior Developer', editing: false, childs: [] })
        data.persons[0].childs.splice(1, 0, { id: 4, name: 'Jamie Torres - DevOps Engineer', editing: false, childs: [] })
        data.persons.splice(1, 0, { id: 2, name: 'Riley Cooper', role: 'QA Lead', editing: false,
                                childs: [{ id: 1, name: 'Casey Morgan - QA Engineer', editing: false, childs: [] }] })
        data.watermark = 'Top Secret'

        console.log('Organization data:', data)
        //console.log(data.persons[0] === data.persons[0])
    </script>

</body>

</html>