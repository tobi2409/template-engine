var INUMBER="INUMBER",IOP1="IOP1",IOP2="IOP2",IOP3="IOP3",IVAR="IVAR",IVARNAME="IVARNAME",IFUNCALL="IFUNCALL",IFUNDEF="IFUNDEF",IEXPR="IEXPR",IEXPREVAL="IEXPREVAL",IMEMBER="IMEMBER",IENDSTATEMENT="IENDSTATEMENT",IARRAY="IARRAY";function Instruction(t,e){this.type=t,this.value=null!=e?e:0}function unaryInstruction(t){return new Instruction(IOP1,t)}function binaryInstruction(t){return new Instruction(IOP2,t)}function ternaryInstruction(t){return new Instruction(IOP3,t)}function simplify(t,e,r,n,s){for(var i,o,a,p,u=[],h=[],c=0;c<t.length;c++){var l=t[c],f=l.type;if(f===INUMBER||f===IVARNAME)Array.isArray(l.value)?u.push.apply(u,simplify(l.value.map((function(t){return new Instruction(INUMBER,t)})).concat(new Instruction(IARRAY,l.value.length)),e,r,n,s)):u.push(l);else if(f===IVAR&&s.hasOwnProperty(l.value))l=new Instruction(INUMBER,s[l.value]),u.push(l);else if(f===IOP2&&u.length>1)o=u.pop(),i=u.pop(),p=r[l.value],l=new Instruction(INUMBER,p(i.value,o.value)),u.push(l);else if(f===IOP3&&u.length>2)a=u.pop(),o=u.pop(),i=u.pop(),"?"===l.value?u.push(i.value?o.value:a.value):(p=n[l.value],l=new Instruction(INUMBER,p(i.value,o.value,a.value)),u.push(l));else if(f===IOP1&&u.length>0)i=u.pop(),p=e[l.value],l=new Instruction(INUMBER,p(i.value)),u.push(l);else if(f===IEXPR){for(;u.length>0;)h.push(u.shift());h.push(new Instruction(IEXPR,simplify(l.value,e,r,n,s)))}else if(f===IMEMBER&&u.length>0)i=u.pop(),u.push(new Instruction(INUMBER,i.value[l.value]));else{for(;u.length>0;)h.push(u.shift());h.push(l)}}for(;u.length>0;)h.push(u.shift());return h}function substitute(t,e,r){for(var n=[],s=0;s<t.length;s++){var i=t[s],o=i.type;if(o===IVAR&&i.value===e)for(var a=0;a<r.tokens.length;a++){var p,u=r.tokens[a];p=u.type===IOP1?unaryInstruction(u.value):u.type===IOP2?binaryInstruction(u.value):u.type===IOP3?ternaryInstruction(u.value):new Instruction(u.type,u.value),n.push(p)}else o===IEXPR?n.push(new Instruction(IEXPR,substitute(i.value,e,r))):n.push(i)}return n}function evaluate(t,e,r){var n,s,i,o,a,p,u=[];if(isExpressionEvaluator(t))return resolveExpression(t,r);for(var h=t.length,c=0;c<h;c++){var l=t[c],f=l.type;if(f===INUMBER||f===IVARNAME)u.push(l.value);else if(f===IOP2)s=u.pop(),n=u.pop(),"and"===l.value?u.push(!!n&&!!evaluate(s,e,r)):"or"===l.value?u.push(!!n||!!evaluate(s,e,r)):"="===l.value?(o=e.binaryOps[l.value],u.push(o(n,evaluate(s,e,r),r))):(o=e.binaryOps[l.value],u.push(o(resolveExpression(n,r),resolveExpression(s,r))));else if(f===IOP3)i=u.pop(),s=u.pop(),n=u.pop(),"?"===l.value?u.push(evaluate(n?s:i,e,r)):(o=e.ternaryOps[l.value],u.push(o(resolveExpression(n,r),resolveExpression(s,r),resolveExpression(i,r))));else if(f===IVAR)if(l.value in e.functions)u.push(e.functions[l.value]);else if(l.value in e.unaryOps&&e.parser.isOperatorEnabled(l.value))u.push(e.unaryOps[l.value]);else{var E=r[l.value];if(void 0===E)throw new Error("undefined variable: "+l.value);u.push(E)}else if(f===IOP1)n=u.pop(),o=e.unaryOps[l.value],u.push(o(resolveExpression(n,r)));else if(f===IFUNCALL){for(p=l.value,a=[];p-- >0;)a.unshift(resolveExpression(u.pop(),r));if(!(o=u.pop()).apply||!o.call)throw new Error(o+" is not a function");u.push(o.apply(void 0,a))}else if(f===IFUNDEF)u.push(function(){for(var t=u.pop(),n=[],s=l.value;s-- >0;)n.unshift(u.pop());var i=u.pop(),o=function(){for(var s=Object.assign({},r),i=0,o=n.length;i<o;i++)s[n[i]]=arguments[i];return evaluate(t,e,s)};return Object.defineProperty(o,"name",{value:i,writable:!1}),r[i]=o,o}());else if(f===IEXPR)u.push(createExpressionEvaluator(l,e));else if(f===IEXPREVAL)u.push(l);else if(f===IMEMBER)n=u.pop(),u.push(n[l.value]);else if(f===IENDSTATEMENT)u.pop();else{if(f!==IARRAY)throw new Error("invalid Expression");for(p=l.value,a=[];p-- >0;)a.unshift(u.pop());u.push(a)}}if(u.length>1)throw new Error("invalid Expression (parity)");return 0===u[0]?0:resolveExpression(u[0],r)}function createExpressionEvaluator(t,e,r){return isExpressionEvaluator(t)?t:{type:IEXPREVAL,value:function(r){return evaluate(t.value,e,r)}}}function isExpressionEvaluator(t){return t&&t.type===IEXPREVAL}function resolveExpression(t,e){return isExpressionEvaluator(t)?t.value(e):t}function expressionToString(t,e){for(var r,n,s,i,o,a,p=[],u=0;u<t.length;u++){var h=t[u],c=h.type;if(c===INUMBER)"number"==typeof h.value&&h.value<0?p.push("("+h.value+")"):Array.isArray(h.value)?p.push("["+h.value.map(escapeValue).join(", ")+"]"):p.push(escapeValue(h.value));else if(c===IOP2)n=p.pop(),r=p.pop(),i=h.value,e?"^"===i?p.push("Math.pow("+r+", "+n+")"):"and"===i?p.push("(!!"+r+" && !!"+n+")"):"or"===i?p.push("(!!"+r+" || !!"+n+")"):"||"===i?p.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+r+"),("+n+")))"):"=="===i?p.push("("+r+" === "+n+")"):"!="===i?p.push("("+r+" !== "+n+")"):"["===i?p.push(r+"[("+n+") | 0]"):p.push("("+r+" "+i+" "+n+")"):"["===i?p.push(r+"["+n+"]"):p.push("("+r+" "+i+" "+n+")");else if(c===IOP3){if(s=p.pop(),n=p.pop(),r=p.pop(),"?"!==(i=h.value))throw new Error("invalid Expression");p.push("("+r+" ? "+n+" : "+s+")")}else if(c===IVAR||c===IVARNAME)p.push(h.value);else if(c===IOP1)r=p.pop(),"-"===(i=h.value)||"+"===i?p.push("("+i+r+")"):e?"not"===i?p.push("(!"+r+")"):"!"===i?p.push("fac("+r+")"):p.push(i+"("+r+")"):"!"===i?p.push("("+r+"!)"):p.push("("+i+" "+r+")");else if(c===IFUNCALL){for(a=h.value,o=[];a-- >0;)o.unshift(p.pop());i=p.pop(),p.push(i+"("+o.join(", ")+")")}else if(c===IFUNDEF){for(n=p.pop(),a=h.value,o=[];a-- >0;)o.unshift(p.pop());r=p.pop(),e?p.push("("+r+" = function("+o.join(", ")+") { return "+n+" })"):p.push("("+r+"("+o.join(", ")+") = "+n+")")}else if(c===IMEMBER)r=p.pop(),p.push(r+"."+h.value);else if(c===IARRAY){for(a=h.value,o=[];a-- >0;)o.unshift(p.pop());p.push("["+o.join(", ")+"]")}else if(c===IEXPR)p.push("("+expressionToString(h.value,e)+")");else if(c!==IENDSTATEMENT)throw new Error("invalid Expression")}return p.length>1&&(p=e?[p.join(",")]:[p.join(";")]),String(p[0])}function escapeValue(t){return"string"==typeof t?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function contains(t,e){for(var r=0;r<t.length;r++)if(t[r]===e)return!0;return!1}function getSymbols(t,e,r){for(var n=!!(r=r||{}).withMembers,s=null,i=0;i<t.length;i++){var o=t[i];o.type===IVAR||o.type===IVARNAME?n||contains(e,o.value)?null!==s?(contains(e,s)||e.push(s),s=o.value):s=o.value:e.push(o.value):o.type===IMEMBER&&n&&null!==s?s+="."+o.value:o.type===IEXPR?getSymbols(o.value,e,r):null!==s&&(contains(e,s)||e.push(s),s=null)}null===s||contains(e,s)||e.push(s)}function Expression(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}Instruction.prototype.toString=function(){switch(this.type){case INUMBER:case IOP1:case IOP2:case IOP3:case IVAR:case IVARNAME:case IENDSTATEMENT:return this.value;case IFUNCALL:return"CALL "+this.value;case IFUNDEF:return"DEF "+this.value;case IARRAY:return"ARRAY "+this.value;case IMEMBER:return"."+this.value;default:return"Invalid Instruction"}},Expression.prototype.simplify=function(t){return t=t||{},new Expression(simplify(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)},Expression.prototype.substitute=function(t,e){return e instanceof Expression||(e=this.parser.parse(String(e))),new Expression(substitute(this.tokens,t,e),this.parser)},Expression.prototype.evaluate=function(t){return t=t||{},evaluate(this.tokens,this,t)},Expression.prototype.toString=function(){return expressionToString(this.tokens,!1)},Expression.prototype.symbols=function(t){t=t||{};var e=[];return getSymbols(this.tokens,e,t),e},Expression.prototype.variables=function(t){t=t||{};var e=[];getSymbols(this.tokens,e,t);var r=this.functions;return e.filter((function(t){return!(t in r)}))},Expression.prototype.toJSFunction=function(t,e){var r=this,n=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+expressionToString(this.simplify(e).tokens,!0)+"; }");return function(){return n.apply(r,arguments)}};var TEOF="TEOF",TOP="TOP",TNUMBER="TNUMBER",TSTRING="TSTRING",TPAREN="TPAREN",TBRACKET="TBRACKET",TCOMMA="TCOMMA",TNAME="TNAME",TSEMICOLON="TSEMICOLON";function Token(t,e,r){this.type=t,this.value=e,this.index=r}function TokenStream(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}Token.prototype.toString=function(){return this.type+": "+this.value},TokenStream.prototype.newToken=function(t,e,r){return new Token(t,e,null!=r?r:this.pos)},TokenStream.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current},TokenStream.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent},TokenStream.prototype.next=function(){return this.pos>=this.expression.length?this.newToken(TEOF,"EOF"):this.isWhitespace()||this.isComment()?this.next():this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName()?this.current:void this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')},TokenStream.prototype.isString=function(){var t=!1,e=this.pos,r=this.expression.charAt(e);if("'"===r||'"'===r)for(var n=this.expression.indexOf(r,e+1);n>=0&&this.pos<this.expression.length;){if(this.pos=n+1,"\\"!==this.expression.charAt(n-1)){var s=this.expression.substring(e+1,n);this.current=this.newToken(TSTRING,this.unescape(s),e),t=!0;break}n=this.expression.indexOf(r,n+1)}return t},TokenStream.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return("("===t||")"===t)&&(this.current=this.newToken(TPAREN,t),this.pos++,!0)},TokenStream.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return!("["!==t&&"]"!==t||!this.isOperatorEnabled("["))&&(this.current=this.newToken(TBRACKET,t),this.pos++,!0)},TokenStream.prototype.isComma=function(){return","===this.expression.charAt(this.pos)&&(this.current=this.newToken(TCOMMA,","),this.pos++,!0)},TokenStream.prototype.isSemicolon=function(){return";"===this.expression.charAt(this.pos)&&(this.current=this.newToken(TSEMICOLON,";"),this.pos++,!0)},TokenStream.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()&&(e===this.pos||"_"!==r&&"."!==r&&(r<"0"||r>"9")))break}if(e>t){var n=this.expression.substring(t,e);if(n in this.consts)return this.current=this.newToken(TNUMBER,this.consts[n]),this.pos+=n.length,!0}return!1},TokenStream.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()&&(e===this.pos||"_"!==r&&(r<"0"||r>"9")))break}if(e>t){var n=this.expression.substring(t,e);if(this.isOperatorEnabled(n)&&(n in this.binaryOps||n in this.unaryOps||n in this.ternaryOps))return this.current=this.newToken(TOP,n),this.pos+=n.length,!0}return!1},TokenStream.prototype.isName=function(){for(var t=this.pos,e=t,r=!1;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()){if(e===this.pos&&("$"===n||"_"===n)){"_"===n&&(r=!0);continue}if(e===this.pos||!r||"_"!==n&&(n<"0"||n>"9"))break}else r=!0}if(r){var s=this.expression.substring(t,e);return this.current=this.newToken(TNAME,s),this.pos+=s.length,!0}return!1},TokenStream.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);!(" "!==e&&"\t"!==e&&"\n"!==e&&"\r"!==e||(t=!0,this.pos++,this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var codePointPattern=/^[0-9a-f]{4}$/i;function ParserState(t,e,r){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=!1!==r.allowMemberAccess}TokenStream.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var r=t.substring(0,e);e>=0;){var n=t.charAt(++e);switch(n){case"'":r+="'";break;case'"':r+='"';break;case"\\":r+="\\";break;case"/":r+="/";break;case"b":r+="\b";break;case"f":r+="\f";break;case"n":r+="\n";break;case"r":r+="\r";break;case"t":r+="\t";break;case"u":var s=t.substring(e+1,e+5);codePointPattern.test(s)||this.parseError("Illegal escape sequence: \\u"+s),r+=String.fromCharCode(parseInt(s,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+n+'"')}++e;var i=t.indexOf("\\",e);r+=t.substring(e,i<0?t.length:i),e=i}return r},TokenStream.prototype.isComment=function(){return"/"===this.expression.charAt(this.pos)&&"*"===this.expression.charAt(this.pos+1)&&(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0)},TokenStream.prototype.isRadixInteger=function(){var t,e,r=this.pos;if(r>=this.expression.length-2||"0"!==this.expression.charAt(r))return!1;if(++r,"x"===this.expression.charAt(r))t=16,e=/^[0-9a-f]$/i,++r;else{if("b"!==this.expression.charAt(r))return!1;t=2,e=/^[01]$/i,++r}for(var n=!1,s=r;r<this.expression.length;){var i=this.expression.charAt(r);if(!e.test(i))break;r++,n=!0}return n&&(this.current=this.newToken(TNUMBER,parseInt(this.expression.substring(s,r),t)),this.pos=r),n},TokenStream.prototype.isNumber=function(){for(var t,e=!1,r=this.pos,n=r,s=r,i=!1,o=!1;r<this.expression.length&&((t=this.expression.charAt(r))>="0"&&t<="9"||!i&&"."===t);)"."===t?i=!0:o=!0,r++,e=o;if(e&&(s=r),"e"===t||"E"===t){r++;for(var a=!0,p=!1;r<this.expression.length;){if(t=this.expression.charAt(r),!a||"+"!==t&&"-"!==t){if(!(t>="0"&&t<="9"))break;p=!0,a=!1}else a=!1;r++}p||(r=s)}return e?(this.current=this.newToken(TNUMBER,parseFloat(this.expression.substring(n,r))),this.pos=r):this.pos=s,e},TokenStream.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if("+"===e||"-"===e||"*"===e||"/"===e||"%"===e||"^"===e||"?"===e||":"===e||"."===e)this.current=this.newToken(TOP,e);else if("∙"===e||"•"===e)this.current=this.newToken(TOP,"*");else if(">"===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,">="),this.pos++):this.current=this.newToken(TOP,">");else if("<"===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"<="),this.pos++):this.current=this.newToken(TOP,"<");else if("|"===e){if("|"!==this.expression.charAt(this.pos+1))return!1;this.current=this.newToken(TOP,"||"),this.pos++}else if("="===e)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"=="),this.pos++):this.current=this.newToken(TOP,e);else{if("!"!==e)return!1;"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"!="),this.pos++):this.current=this.newToken(TOP,e)}return this.pos++,!!this.isOperatorEnabled(this.current.value)||(this.pos=t,!1)},TokenStream.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)},TokenStream.prototype.getCoordinates=function(){var t,e=0,r=-1;do{e++,t=this.pos-r,r=this.expression.indexOf("\n",r+1)}while(r>=0&&r<this.pos);return{line:e,column:t}},TokenStream.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)},ParserState.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()},ParserState.prototype.tokenMatches=function(t,e){return void 0===e||(Array.isArray(e)?contains(e,t.value):"function"==typeof e?e(t):t.value===e)},ParserState.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()},ParserState.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken},ParserState.prototype.accept=function(t,e){return!(this.nextToken.type!==t||!this.tokenMatches(this.nextToken,e))&&(this.next(),!0)},ParserState.prototype.expect=function(t,e){if(!this.accept(t,e)){var r=this.tokens.getCoordinates();throw new Error("parse error ["+r.line+":"+r.column+"]: Expected "+(e||t))}},ParserState.prototype.parseAtom=function(t){var e=this.tokens.unaryOps;if(this.accept(TNAME)||this.accept(TOP,(function(t){return t.value in e})))t.push(new Instruction(IVAR,this.current.value));else if(this.accept(TNUMBER))t.push(new Instruction(INUMBER,this.current.value));else if(this.accept(TSTRING))t.push(new Instruction(INUMBER,this.current.value));else if(this.accept(TPAREN,"("))this.parseExpression(t),this.expect(TPAREN,")");else{if(!this.accept(TBRACKET,"["))throw new Error("unexpected "+this.nextToken);if(this.accept(TBRACKET,"]"))t.push(new Instruction(IARRAY,0));else{var r=this.parseArrayList(t);t.push(new Instruction(IARRAY,r))}}},ParserState.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),this.parseUntilEndStatement(t,e)||this.pushExpression(t,e))},ParserState.prototype.pushExpression=function(t,e){for(var r=0,n=e.length;r<n;r++)t.push(e[r])},ParserState.prototype.parseUntilEndStatement=function(t,e){return!!this.accept(TSEMICOLON)&&(!this.nextToken||this.nextToken.type===TEOF||this.nextToken.type===TPAREN&&")"===this.nextToken.value||e.push(new Instruction(IENDSTATEMENT)),this.nextToken.type!==TEOF&&this.parseExpression(e),t.push(new Instruction(IEXPR,e)),!0)},ParserState.prototype.parseArrayList=function(t){for(var e=0;!this.accept(TBRACKET,"]");)for(this.parseExpression(t),++e;this.accept(TCOMMA);)this.parseExpression(t),++e;return e},ParserState.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(TOP,"=");){var e=t.pop(),r=[],n=t.length-1;if(e.type!==IFUNCALL){if(e.type!==IVAR&&e.type!==IMEMBER)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(r),t.push(new Instruction(IVARNAME,e.value)),t.push(new Instruction(IEXPR,r)),t.push(binaryInstruction("="))}else{if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var s=0,i=e.value+1;s<i;s++){var o=n-s;t[o].type===IVAR&&(t[o]=new Instruction(IVARNAME,t[o].value))}this.parseVariableAssignmentExpression(r),t.push(new Instruction(IEXPR,r)),t.push(new Instruction(IFUNDEF,e.value))}}},ParserState.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(TOP,"?");){var e=[],r=[];this.parseConditionalExpression(e),this.expect(TOP,":"),this.parseConditionalExpression(r),t.push(new Instruction(IEXPR,e)),t.push(new Instruction(IEXPR,r)),t.push(ternaryInstruction("?"))}},ParserState.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(TOP,"or");){var e=[];this.parseAndExpression(e),t.push(new Instruction(IEXPR,e)),t.push(binaryInstruction("or"))}},ParserState.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(TOP,"and");){var e=[];this.parseComparison(e),t.push(new Instruction(IEXPR,e)),t.push(binaryInstruction("and"))}};var COMPARISON_OPERATORS=["==","!=","<","<=",">=",">","in"];ParserState.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(TOP,COMPARISON_OPERATORS);){var e=this.current;this.parseAddSub(t),t.push(binaryInstruction(e.value))}};var ADD_SUB_OPERATORS=["+","-","||"];ParserState.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(TOP,ADD_SUB_OPERATORS);){var e=this.current;this.parseTerm(t),t.push(binaryInstruction(e.value))}};var TERM_OPERATORS=["*","/","%"];function add(t,e){return Number(t)+Number(e)}function sub(t,e){return t-e}function mul(t,e){return t*e}function div(t,e){return t/e}function mod(t,e){return t%e}function concat(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function equal(t,e){return t===e}function notEqual(t,e){return t!==e}function greaterThan(t,e){return t>e}function lessThan(t,e){return t<e}function greaterThanEqual(t,e){return t>=e}function lessThanEqual(t,e){return t<=e}function andOperator(t,e){return Boolean(t&&e)}function orOperator(t,e){return Boolean(t||e)}function inOperator(t,e){return contains(e,t)}function sinh(t){return(Math.exp(t)-Math.exp(-t))/2}function cosh(t){return(Math.exp(t)+Math.exp(-t))/2}function tanh(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function asinh(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function acosh(t){return Math.log(t+Math.sqrt(t*t-1))}function atanh(t){return Math.log((1+t)/(1-t))/2}function log10(t){return Math.log(t)*Math.LOG10E}function neg(t){return-t}function not(t){return!t}function trunc(t){return t<0?Math.ceil(t):Math.floor(t)}function random(t){return Math.random()*(t||1)}function factorial(t){return gamma(t+1)}function isInteger(t){return isFinite(t)&&t===Math.round(t)}ParserState.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(TOP,TERM_OPERATORS);){var e=this.current;this.parseFactor(t),t.push(binaryInstruction(e.value))}},ParserState.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;if(this.save(),this.accept(TOP,(function(t){return t.value in e}))){if("-"!==this.current.value&&"+"!==this.current.value){if(this.nextToken.type===TPAREN&&"("===this.nextToken.value)return this.restore(),void this.parseExponential(t);if(this.nextToken.type===TSEMICOLON||this.nextToken.type===TCOMMA||this.nextToken.type===TEOF||this.nextToken.type===TPAREN&&")"===this.nextToken.value)return this.restore(),void this.parseAtom(t)}var r=this.current;this.parseFactor(t),t.push(unaryInstruction(r.value))}else this.parseExponential(t)},ParserState.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(TOP,"^");)this.parseFactor(t),t.push(binaryInstruction("^"))},ParserState.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(TOP,"!");)t.push(unaryInstruction("!"))},ParserState.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;if(this.accept(TOP,(function(t){return t.value in e}))){var r=this.current;this.parseAtom(t),t.push(unaryInstruction(r.value))}else for(this.parseMemberExpression(t);this.accept(TPAREN,"(");)if(this.accept(TPAREN,")"))t.push(new Instruction(IFUNCALL,0));else{var n=this.parseArgumentList(t);t.push(new Instruction(IFUNCALL,n))}},ParserState.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(TPAREN,")");)for(this.parseExpression(t),++e;this.accept(TCOMMA);)this.parseExpression(t),++e;return e},ParserState.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(TOP,".")||this.accept(TBRACKET,"[");){var e=this.current;if("."===e.value){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(TNAME),t.push(new Instruction(IMEMBER,this.current.value))}else{if("["!==e.value)throw new Error("unexpected symbol: "+e.value);if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(TBRACKET,"]"),t.push(binaryInstruction("["))}}};var GAMMA_G=4.7421875,GAMMA_P=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function gamma(t){var e,r;if(isInteger(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var n=t-2,s=t-1;n>1;)s*=n,n--;return 0===s&&(s=1),s}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*gamma(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,o=i*t,a=o*t,p=a*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*o)-571/(2488320*a)+163879/(209018880*p)+5246819/(75246796800*p*t))}--t,r=GAMMA_P[0];for(var u=1;u<GAMMA_P.length;++u)r+=GAMMA_P[u]/(t+u);return e=t+GAMMA_G+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*r}function stringOrArrayLength(t){return Array.isArray(t)?t.length:String(t).length}function hypot(){for(var t=0,e=0,r=0;r<arguments.length;r++){var n,s=Math.abs(arguments[r]);e<s?(t=t*(n=e/s)*n+1,e=s):t+=s>0?(n=s/e)*n:s}return e===1/0?1/0:e*Math.sqrt(t)}function condition(t,e,r){return t?e:r}function roundTo(t,e){return void 0===e||0==+e?Math.round(t):(t=+t,e=-+e,isNaN(t)||"number"!=typeof e||e%1!=0?NaN:(t=t.toString().split("e"),+((t=(t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e)))).toString().split("e"))[0]+"e"+(t[1]?+t[1]+e:e))))}function setVar(t,e,r){return r&&(r[t]=e),e}function arrayIndex(t,e){return t[0|e]}function max(t){return 1===arguments.length&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function min(t){return 1===arguments.length&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function arrayMap(t,e){if("function"!=typeof t)throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map((function(e,r){return t(e,r)}))}function arrayFold(t,e,r){if("function"!=typeof t)throw new Error("First argument to fold is not a function");if(!Array.isArray(r))throw new Error("Second argument to fold is not an array");return r.reduce((function(e,r,n){return t(e,r,n)}),e)}function arrayFilter(t,e){if("function"!=typeof t)throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter((function(e,r){return t(e,r)}))}function stringOrArrayIndexOf(t,e){if(!Array.isArray(e)&&"string"!=typeof e)throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function arrayJoin(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function sign(t){return(t>0)-(t<0)||+t}var ONE_THIRD=1/3;function cbrt(t){return t<0?-Math.pow(-t,ONE_THIRD):Math.pow(t,ONE_THIRD)}function expm1(t){return Math.exp(t)-1}function log1p(t){return Math.log(1+t)}function log2(t){return Math.log(t)/Math.LN2}function Parser(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||sinh,cosh:Math.cosh||cosh,tanh:Math.tanh||tanh,asinh:Math.asinh||asinh,acosh:Math.acosh||acosh,atanh:Math.atanh||atanh,sqrt:Math.sqrt,cbrt:Math.cbrt||cbrt,log:Math.log,log2:Math.log2||log2,ln:Math.log,lg:Math.log10||log10,log10:Math.log10||log10,expm1:Math.expm1||expm1,log1p:Math.log1p||log1p,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||trunc,"-":neg,"+":Number,exp:Math.exp,not:not,length:stringOrArrayLength,"!":factorial,sign:Math.sign||sign},this.binaryOps={"+":add,"-":sub,"*":mul,"/":div,"%":mod,"^":Math.pow,"||":concat,"==":equal,"!=":notEqual,">":greaterThan,"<":lessThan,">=":greaterThanEqual,"<=":lessThanEqual,and:andOperator,or:orOperator,in:inOperator,"=":setVar,"[":arrayIndex},this.ternaryOps={"?":condition},this.functions={random:random,fac:factorial,min:min,max:max,hypot:Math.hypot||hypot,pyt:Math.hypot||hypot,pow:Math.pow,atan2:Math.atan2,if:condition,gamma:gamma,roundTo:roundTo,map:arrayMap,fold:arrayFold,filter:arrayFilter,indexOf:stringOrArrayIndexOf,join:arrayJoin},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Parser.prototype.parse=function(t){var e=[],r=new ParserState(this,new TokenStream(this,t),{allowMemberAccess:this.options.allowMemberAccess});return r.parseExpression(e),r.expect(TEOF,"EOF"),new Expression(e,this)},Parser.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var sharedParser=new Parser;Parser.parse=function(t){return sharedParser.parse(t)},Parser.evaluate=function(t,e){return sharedParser.parse(t).evaluate(e)};var optionNameMap={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function getOptionName(t){return optionNameMap.hasOwnProperty(t)?optionNameMap[t]:t}Parser.prototype.isOperatorEnabled=function(t){var e=getOptionName(t),r=this.options.operators||{};return!(e in r)||!!r[e]};
/*!
 Based on ndef.parser, by Raphael Graf(r@undefined.ch)
 http://www.undefined.ch/mparser/index.html

 Ported to JavaScript and modified by Matthew Crumley (email@matthewcrumley.com, http://silentmatt.com/)

 You are free to use and modify this code in anyway you find useful. Please leave this comment in the code
 to acknowledge its original source. If you feel like it, I enjoy hearing about projects that use my code,
 but don't feel like you have to let me know or ask permission.
*/
var index={Parser:Parser,Expression:Expression};export default index;export{Expression,Parser};